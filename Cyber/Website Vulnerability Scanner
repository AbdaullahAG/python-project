# تثبيت كل المكتبات المطلوبة مرة واحدة
!pip install requests beautifulsoup4 fpdf2 ipywidgets --quiet

import requests
from bs4 import BeautifulSoup
import ipywidgets as widgets
from IPython.display import display, clear_output, HTML
from fpdf import FPDF
from datetime import datetime
import io

# ألوان HTML للواجهة
STYLE = """
<style>
    .title {font-size: 28px; font-weight: bold; color: #d32f2f; text-align: center; margin: 20px;}
    .subtitle {font-size: 18px; color: #1976d2; text-align: center;}
    .result-good {color: green; font-weight: bold;}
    .result-bad {color: red; font-weight: bold;}
    .result-warn {color: orange; font-weight: bold;}
</style>
"""

display(HTML(STYLE + """
<div class="title">Website Vulnerability Scanner</div>
<div class="subtitle">فاحص ثغرات أمنية تفاعلي - SQLi • XSS • HTTPS</div>
"""))

# حقل إدخال الرابط
url_input = widgets.Text(
    value='http://testphp.vulnweb.com',
    placeholder='أدخل رابط الموقع هنا',
    description='الموقع:',
    layout=widgets.Layout(width='80%'),
    style={'description_width': '80px'}
)

# زر الفحص
scan_button = widgets.Button(
    description='ابدأ الفحص',
    button_style='danger',
    layout=widgets.Layout(width='200px', height='50px')
)

# مكان إظهار النتايج
output = widgets.Output()

def run_scan(b):
    with output:
        clear_output()
        url = url_input.value.strip()
        if not url:
            print("خطأ: أدخل رابط صحيح!")
            return
        
        if not url.startswith(("http://", "https://")):
            url = "http://" + url
            
        print(f"جاري فحص: {url}\n{'═'*60}")
        results = []
        results.append(f"تقرير فحص أمني\nالتاريخ: {datetime.now().strftime('%Y-%m-%d %H:%M')}")
        results.append(f"الهدف: {url}\n{'─'*60}")

        # 1. فحص HTTPS
        try:
            r = requests.get(url, timeout=12, verify=True)
            if r.url.startswith("https://"):
                print("HTTPS مستخدم وشهادة SSL سليمة")
                results.append("HTTPS: آمن")
            else:
                print("تحذير: الموقع يعمل بـ HTTP فقط → عرضة للاختراق")
                results.append("HTTPS: غير آمن (HTTP)")
        except requests.exceptions.SSLError:
            print("مشكلة في شهادة SSL")
            results.append("HTTPS: شهادة منتهية أو غير موثوقة")
        except:
            print("لا يمكن الوصول للموقع")
            results.append("HTTPS: لا يمكن الوصول")

        # 2. فحص SQL Injection
        payloads = ["' OR '1'='1", "' OR '1'='1' --", "admin' --"]
        sqli_found = False
        for p in payloads:
            try:
                test_url = f"{url}?id={p}" if "?" in url else f"{url}?q={p}"
                resp = requests.get(test_url, timeout=8)
                if any(k in resp.text.lower() for k in ["sql", "syntax", "mysql", "error"]):
                    print(f"ثغرة SQL Injection مكتشفة! (Payload: {p})")
                    results.append(f"SQL Injection: موجودة → {p}")
                    sqli_found = True
                    break
            except:
                pass
        if not sqli_found:
            print("لا توجد ثغرة SQL Injection واضحة")
            results.append("SQL Injection: غير موجودة")

        # 3. فحص XSS
        xss_payload = "<script>alert('XSS_By_YourName')</script>"
        try:
            test_url = f"{url}?q={p}}" if "?" in url else f"{url}?search={xss_payload}"
            resp = requests.get(test_url, timeout=8)
            if xss_payload in resp.text:
                print("ثغرة XSS مكتشفة → الكود نفّذ!")
                results.append("XSS: موجودة")
            else:
                print("لا توجد ثغرة XSS واضحة")
                results.append("XSS: غير موجودة")
        except:
            print("لا يمكن اختبار XSS")
            results.append("XSS: غير قابل للفحص")

        print(f"\n{'═'*60}\nالفحص انتهى!")

        # زر تحميل التقرير PDF
        pdf = FPDF()
        pdf.add_page()
        pdf.add_font("DejaVu", "", "DejaVuSans.ttf", uni=True)  # خط عربي
        pdf.set_font("DejaVu", size=12)
        pdf.cell(200, 10, txt="تقرير فحص أمني", ln=1, align='C')
        pdf.cell(200, 10, txt=f"التاريخ: {datetime.now().strftime('%Y-%m-%d %H:%M')}", ln=1)
        pdf.cell(200, 10, txt=f"الموقع: {url}", ln=2)
        for line in results[2:]:
            pdf.cell(200, 10, txt=line, ln=1)
        
        pdf_output = io.BytesIO()
        pdf.output(pdf_output)
        pdf_data = pdf_output.getvalue()

        download_btn = widgets.Button(description="تحميل التقرير PDF")
        def download_pdf(b):
            from google.colab import files
            with open("تقرير_الفحص.pdf", "wb") as f:
                f.write(pdf_data)
            files.download("تقرير_الفحص.pdf")
        
        download_btn.on_click(download_pdf)
        display(download_btn)

# ربط الزر بالدالة
scan_button.on_click(run_scan)

# عرض الواجهة
display(url_input)
display(scan_button)
display(output)
